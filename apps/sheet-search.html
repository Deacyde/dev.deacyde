<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sheet Search | Deacyde</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0d0d0d; color: #fff; padding: 2rem 1rem; min-height: 100vh; }
    a.back { color: #888; text-decoration: none; font-size: 0.9rem; display: inline-block; margin-bottom: 1.5rem; }
    a.back:hover { color: #fff; }
    h1 { font-size: 1.8rem; margin-bottom: 0.4rem; }
    .subtitle { color: #888; margin-bottom: 2rem; font-size: 0.95rem; }

    .load-panel { background: #111; border: 1px solid #222; border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .load-panel h2 { font-size: 1rem; margin-bottom: 1rem; color: #aaa; font-weight: 500; }
    .load-row { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; }
    .load-row input[type="text"] { flex: 1; min-width: 240px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: #fff; padding: 0.55rem 0.9rem; font-size: 0.9rem; }
    .load-row input[type="text"]::placeholder { color: #555; }
    .load-row input[type="file"] { display: none; }
    label.btn, button.btn { cursor: pointer; background: #428bca; color: #fff; border: none; border-radius: 6px; padding: 0.55rem 1.1rem; font-size: 0.9rem; font-weight: 600; transition: background 0.2s; white-space: nowrap; }
    label.btn:hover, button.btn:hover { background: #357ab7; }
    button.btn.secondary { background: #222; border: 1px solid #444; }
    button.btn.secondary:hover { background: #333; }
    .or { color: #555; font-size: 0.85rem; }
    #status-msg { font-size: 0.85rem; color: #888; margin-top: 0.75rem; }
    #status-msg.error { color: #e05; }
    #status-msg.ok { color: #4c4; }

    .filters-bar { display: flex; gap: 0.6rem; flex-wrap: wrap; margin-bottom: 1rem; align-items: center; }
    .filters-bar input[type="text"] { flex: 1; min-width: 200px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: #fff; padding: 0.5rem 0.9rem; font-size: 0.9rem; }
    .filters-bar input[type="text"]::placeholder { color: #555; }
    .filters-bar select { background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: #fff; padding: 0.5rem 0.6rem; font-size: 0.82rem; cursor: pointer; max-width: 160px; }
    .filter-count { font-size: 0.82rem; color: #555; white-space: nowrap; margin-left: auto; }
    button#clear-btn { background: none; border: 1px solid #333; color: #888; border-radius: 6px; padding: 0.5rem 0.9rem; font-size: 0.82rem; cursor: pointer; }
    button#clear-btn:hover { border-color: #666; color: #fff; }

    .col-toggle { background: #111; border: 1px solid #222; border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem; font-size: 0.82rem; }
    .col-toggle summary { cursor: pointer; color: #888; user-select: none; }
    .col-toggle summary:hover { color: #fff; }
    .col-pills { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.75rem; }
    .col-pill { display: inline-flex; align-items: center; gap: 0.3rem; background: #1a1a1a; border: 1px solid #333; border-radius: 99px; padding: 0.25rem 0.6rem; font-size: 0.78rem; cursor: pointer; user-select: none; }
    .col-pill.active { background: #1a3355; border-color: #428bca; color: #7bc; }
    .col-pill:hover { border-color: #555; }

    .table-wrap { overflow-x: auto; border-radius: 10px; border: 1px solid #222; }
    table { width: 100%; border-collapse: collapse; font-size: 0.83rem; }
    thead tr { background: #161616; }
    th { padding: 0.65rem 0.9rem; text-align: left; color: #aaa; font-weight: 600; font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.03em; border-bottom: 1px solid #222; white-space: nowrap; cursor: pointer; }
    th:hover { color: #fff; }
    tbody tr { border-bottom: 1px solid #1a1a1a; transition: background 0.1s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: #161616; }
    td { padding: 0.6rem 0.9rem; vertical-align: top; color: #ccc; max-width: 260px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    td a { color: #428bca; text-decoration: none; }
    td a:hover { text-decoration: underline; }
    .empty { text-align: center; padding: 3rem; color: #555; }
    #placeholder { text-align: center; padding: 4rem 2rem; color: #444; }
    #placeholder .icon { font-size: 3rem; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <a href="../index.html" class="back">‚Üê Back</a>
  <h1>Sheet Search</h1>
  <p class="subtitle">Load your Google Sheet or CSV and search/filter every column.</p>

  <div class="load-panel">
    <h2>Load data</h2>
    <div class="load-row">
      <input type="text" id="sheet-url" placeholder="Paste Google Sheet URL (any format)‚Ä¶" />
      <button class="btn" onclick="loadFromURL()">Fetch Sheet</button>
      <span class="or">or</span>
      <label class="btn secondary">Upload CSV <input type="file" id="csv-file" accept=".csv" onchange="loadFromFile(this)" /></label>
    </div>
    <div id="status-msg"></div>
    <div style="margin-top:0.9rem; font-size:0.8rem; color:#555;">
      üí° Paste any Google Sheet URL ‚Äî set sharing to <strong>"Anyone with the link can view"</strong> or publish as CSV. The app reads your actual column headers automatically.
    </div>
  </div>

  <div id="app" style="display:none;">
    <details class="col-toggle" id="col-picker">
      <summary>‚öôÔ∏è Choose visible columns (<span id="col-count">0</span> shown)</summary>
      <div class="col-pills" id="col-pills"></div>
    </details>

    <div class="filters-bar" id="filters-bar">
      <input type="text" id="search" placeholder="Search all columns‚Ä¶" oninput="applyFilters()" />
      <span class="filter-count" id="result-count"></span>
      <button id="clear-btn" onclick="clearFilters()">Clear</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead id="tbl-head"></thead>
        <tbody id="tbl-body"></tbody>
      </table>
    </div>
  </div>

  <div id="placeholder">
    <div class="icon">üìä</div>
    <p>Load a Google Sheet or upload a CSV to get started.</p>
  </div>

  <script>
    // Columns to use as filter dropdowns (matched by header name)
    const FILTER_COLS = ['keyword cluster', 'target keyword', 'business units', 'tiger team', 'buying phase', 'product pillars', 'products'];
    // Columns to search through
    const SEARCH_COLS = ['permalink', 'keyword cluster', 'target keyword', 'topics'];

    let allRows = [], headers = [], visibleCols = [], activeFilters = {};
    let filterColIdxs = [], searchColIdxs = [];

    function setStatus(msg, type = '') {
      const el = document.getElementById('status-msg');
      el.textContent = msg;
      el.className = type;
    }

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      return lines.map(line => {
        const cells = [];
        let cur = '', inQ = false;
        for (let i = 0; i < line.length; i++) {
          const c = line[i];
          if (c === '"') { inQ = !inQ; }
          else if (c === ',' && !inQ) { cells.push(cur.trim()); cur = ''; }
          else cur += c;
        }
        cells.push(cur.trim());
        return cells;
      });
    }

    function toCSVExportURL(input) {
      if (input.includes('output=csv') || input.includes('format=csv')) return input;
      if (input.match(/\/spreadsheets\/d\/e\//)) {
        return input + (input.includes('?') ? '&' : '?') + 'output=csv';
      }
      const idMatch = input.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]{20,})/);
      if (idMatch) {
        const gidMatch = input.match(/[#&?]gid=(\d+)/);
        return `https://docs.google.com/spreadsheets/d/${idMatch[1]}/export?format=csv&gid=${gidMatch ? gidMatch[1] : '0'}`;
      }
      return input;
    }

    function loadData(text, source) {
      const rows = parseCSV(text);
      if (rows.length < 2) { setStatus('No data found.', 'error'); return; }
      headers = rows[0];
      allRows = rows.slice(1);
      // Resolve filter and search column indices from headers
      const lh = headers.map(h => h.toLowerCase().trim());
      filterColIdxs = FILTER_COLS.map(name => lh.findIndex(h => h.includes(name))).filter(i => i >= 0);
      searchColIdxs = SEARCH_COLS.map(name => lh.findIndex(h => h.includes(name))).filter(i => i >= 0);
      console.log('filterColIdxs:', filterColIdxs.map(i => `${i}=${headers[i]}`));
      // Default: show first 10 columns
      visibleCols = headers.map((_, i) => i).slice(0, 10);
      activeFilters = {};
      buildColPicker();
      buildFilterDropdowns();
      applyFilters();
      document.getElementById('app').style.display = '';
      document.getElementById('placeholder').style.display = 'none';
      setStatus(`‚úì Loaded ${allRows.length} rows ¬∑ ${headers.length} columns from ${source}`, 'ok');
    }

    function buildColPicker() {
      const pills = document.getElementById('col-pills');
      pills.innerHTML = headers.map((h, i) => `
        <span class="col-pill ${visibleCols.includes(i) ? 'active' : ''}" onclick="toggleCol(${i})" id="pill-${i}">${h || `Col ${i+1}`}</span>
      `).join('');
      updateColCount();
    }

    function toggleCol(i) {
      if (visibleCols.includes(i)) {
        if (visibleCols.length === 1) return; // keep at least 1
        visibleCols = visibleCols.filter(c => c !== i);
      } else {
        visibleCols = [...visibleCols, i].sort((a,b) => a-b);
      }
      document.getElementById(`pill-${i}`).classList.toggle('active');
      updateColCount();
      renderTable(getFiltered());
    }

    function updateColCount() {
      document.getElementById('col-count').textContent = visibleCols.length;
    }

    // Build dropdown filters for the specified columns only
    function buildFilterDropdowns() {
      const bar = document.getElementById('filters-bar');
      bar.querySelectorAll('select').forEach(s => s.remove());
      const insertBefore = document.getElementById('result-count');

      filterColIdxs.forEach(i => {
        const h = headers[i];
        const vals = [...new Set(allRows.map(r => (r[i] || '').trim()))].filter(v => v);
        if (!vals.length) return;
        const sel = document.createElement('select');
        sel.dataset.col = i;
        sel.innerHTML = `<option value="">All ${h}</option>` + vals.sort().map(v => `<option value="${v}">${v}</option>`).join('');
        sel.addEventListener('change', () => { activeFilters[i] = sel.value; applyFilters(); });
        bar.insertBefore(sel, insertBefore);
      });
    }

    function getFiltered() {
      const q = (document.getElementById('search').value || '').toLowerCase();
      return allRows.filter(r => {
        if (q && !searchColIdxs.some(i => (r[i] || '').toLowerCase().includes(q))) return false;
        for (const [col, val] of Object.entries(activeFilters)) {
          if (val && (r[col] || '').trim() !== val) return false;
        }
        return true;
      });
    }

    function applyFilters() {
      const filtered = getFiltered();
      document.getElementById('result-count').textContent = `${filtered.length} of ${allRows.length}`;
      renderTable(filtered);
    }

    function renderTable(rows) {
      const esc = v => (v || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const isURL = v => /^https?:\/\//i.test(v);

      document.getElementById('tbl-head').innerHTML = '<tr>' +
        visibleCols.map(i => `<th>${esc(headers[i] || `Col ${i+1}`)}</th>`).join('') + '</tr>';

      if (!rows.length) {
        document.getElementById('tbl-body').innerHTML = `<tr><td colspan="${visibleCols.length}" class="empty">No results.</td></tr>`;
        return;
      }

      document.getElementById('tbl-body').innerHTML = rows.slice(0, 500).map(r =>
        '<tr>' + visibleCols.map(i => {
          const v = r[i] || '';
          const cell = isURL(v) ? `<a href="${esc(v)}" target="_blank" rel="noopener" title="${esc(v)}">${esc(v)}</a>` : esc(v);
          return `<td title="${esc(v)}">${cell}</td>`;
        }).join('') + '</tr>'
      ).join('');
    }

    async function loadFromURL() {
      const raw = document.getElementById('sheet-url').value.trim();
      if (!raw) { setStatus('Please enter a URL.', 'error'); return; }
      const url = toCSVExportURL(raw);
      setStatus('Fetching‚Ä¶');
      try {
        const res = await fetch(`https://empty-bonus-280d.muddy-river-68bb.workers.dev/?url=${encodeURIComponent(url)}`);
        const data = await res.json();
        if (!data.contents || data.contents.trim().startsWith('<')) throw new Error('Got HTML ‚Äî check sharing settings');
        loadData(data.contents, 'Google Sheets');
      } catch(e) {
        setStatus(`Failed: ${e.message}`, 'error');
      }
    }

    function loadFromFile(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => loadData(e.target.result, file.name);
      reader.readAsText(file);
    }

    function clearFilters() {
      document.getElementById('search').value = '';
      activeFilters = {};
      document.querySelectorAll('#filters-bar select').forEach(s => s.value = '');
      applyFilters();
    }
  </script>
</body>
</html>
