<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rich Text ‚Üî Markdown Converter</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0d0d0d; --surface: #1a1a1a; --surface2: #242424; --border: #333;
  --accent: #7c3aed; --accent-light: #a78bfa; --text: #e8e8e8; --text2: #aaa; --text3: #666;
}
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
a { color: var(--accent-light); text-decoration: none; }

.topbar {
  display: flex; align-items: center; gap: 12px; padding: 12px 20px;
  border-bottom: 1px solid var(--border); background: var(--surface);
}
.topbar h1 { font-size: 16px; font-weight: 600; flex: 1; }
.back-link { font-size: 13px; color: var(--text3); }
.back-link:hover { color: var(--text); }

.btn { padding: 6px 14px; border: 1px solid var(--border); border-radius: 6px; background: var(--surface2); color: var(--text); cursor: pointer; font-size: 13px; transition: all .15s; }
.btn:hover { border-color: var(--accent); color: #fff; }
.btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
.btn-primary:hover { background: #6d28d9; }
.btn-sm { padding: 4px 10px; font-size: 12px; }

.toolbar {
  display: flex; gap: 8px; padding: 10px 20px; border-bottom: 1px solid var(--border);
  background: var(--surface); flex-wrap: wrap; align-items: center;
}
.toolbar .sep { width: 1px; height: 20px; background: var(--border); }
.mode-tabs { display: flex; gap: 0; }
.mode-tab { padding: 6px 16px; border: 1px solid var(--border); background: var(--surface2); color: var(--text2); cursor: pointer; font-size: 13px; transition: all .15s; }
.mode-tab:first-child { border-radius: 6px 0 0 6px; }
.mode-tab:last-child { border-radius: 0 6px 6px 0; }
.mode-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }
.mode-tab + .mode-tab { border-left: 0; }

.main {
  display: grid; grid-template-columns: 1fr 1fr; height: calc(100vh - 95px);
}
.main.single { grid-template-columns: 1fr; }
.pane { display: flex; flex-direction: column; border-right: 1px solid var(--border); min-width: 0; }
.pane:last-child { border-right: none; }
.pane-header {
  display: flex; align-items: center; gap: 8px; padding: 8px 16px;
  background: var(--surface); border-bottom: 1px solid var(--border); font-size: 12px; color: var(--text2);
}
.pane-header .label { flex: 1; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; }
.pane-body { flex: 1; overflow: auto; position: relative; }

/* Rich text editor */
.rich-editor {
  min-height: 100%; padding: 20px; outline: none; font-size: 14px; line-height: 1.7;
  color: var(--text); word-wrap: break-word; overflow-wrap: break-word;
}
.rich-editor:empty::before {
  content: 'Paste or type rich text here‚Ä¶'; color: var(--text3);
}
.rich-editor h1, .rich-editor h2, .rich-editor h3 { margin: 0.8em 0 0.4em; color: #fff; }
.rich-editor h1 { font-size: 1.6em; }
.rich-editor h2 { font-size: 1.3em; }
.rich-editor h3 { font-size: 1.1em; }
.rich-editor p { margin: 0.4em 0; }
.rich-editor ul, .rich-editor ol { padding-left: 1.5em; margin: 0.4em 0; }
.rich-editor li { margin: 0.2em 0; }
.rich-editor code { background: var(--surface2); padding: 2px 6px; border-radius: 4px; font-family: 'SF Mono', Monaco, Consolas, monospace; font-size: 0.9em; color: var(--accent-light); }
.rich-editor pre { background: var(--surface2); padding: 12px 16px; border-radius: 8px; overflow-x: auto; margin: 0.6em 0; }
.rich-editor pre code { background: none; padding: 0; }
.rich-editor blockquote { border-left: 3px solid var(--accent); padding-left: 12px; color: var(--text2); margin: 0.6em 0; }
.rich-editor a { color: var(--accent-light); text-decoration: underline; }
.rich-editor strong { color: #fff; }
.rich-editor table { border-collapse: collapse; margin: 0.6em 0; width: 100%; }
.rich-editor th, .rich-editor td { border: 1px solid var(--border); padding: 6px 10px; text-align: left; font-size: 13px; }
.rich-editor th { background: var(--surface2); color: #fff; }
.rich-editor img { max-width: 100%; border-radius: 6px; }
.rich-editor hr { border: none; border-top: 1px solid var(--border); margin: 1em 0; }

/* Markdown editor */
.md-editor {
  width: 100%; height: 100%; padding: 20px; border: none; outline: none; resize: none;
  font-family: 'SF Mono', Monaco, Consolas, monospace; font-size: 13px; line-height: 1.7;
  background: transparent; color: var(--text); tab-size: 2;
  word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap;
}
.md-editor::placeholder { color: var(--text3); }

/* Preview pane */
.preview {
  padding: 20px; font-size: 14px; line-height: 1.7; word-wrap: break-word; overflow-wrap: break-word;
}
.preview h1, .preview h2, .preview h3 { margin: 0.8em 0 0.4em; color: #fff; }
.preview h1 { font-size: 1.6em; border-bottom: 1px solid var(--border); padding-bottom: 0.3em; }
.preview h2 { font-size: 1.3em; }
.preview p { margin: 0.4em 0; }
.preview ul, .preview ol { padding-left: 1.5em; margin: 0.4em 0; }
.preview code { background: var(--surface2); padding: 2px 6px; border-radius: 4px; font-family: 'SF Mono', Monaco, Consolas, monospace; font-size: 0.9em; color: var(--accent-light); }
.preview pre { background: var(--surface2); padding: 12px 16px; border-radius: 8px; overflow-x: auto; margin: 0.6em 0; white-space: pre-wrap; }
.preview pre code { background: none; padding: 0; }
.preview blockquote { border-left: 3px solid var(--accent); padding-left: 12px; color: var(--text2); margin: 0.6em 0; }
.preview strong { color: #fff; }
.preview table { border-collapse: collapse; margin: 0.6em 0; width: 100%; }
.preview th, .preview td { border: 1px solid var(--border); padding: 6px 10px; text-align: left; font-size: 13px; }
.preview th { background: var(--surface2); color: #fff; }
.preview hr { border: none; border-top: 1px solid var(--border); margin: 1em 0; }

.copy-toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: var(--accent); color: #fff; padding: 8px 20px; border-radius: 8px;
  font-size: 13px; opacity: 0; transition: opacity .3s; pointer-events: none; z-index: 100;
}
.copy-toast.show { opacity: 1; }

/* Export dropdown */
.export-wrap { position: relative; }
.export-menu {
  display: none; position: absolute; top: 100%; left: 0; margin-top: 4px;
  background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
  min-width: 180px; padding: 4px 0; z-index: 50; box-shadow: 0 8px 24px rgba(0,0,0,.4);
}
.export-menu.open { display: block; }
.export-opt {
  padding: 8px 14px; font-size: 13px; color: var(--text); cursor: pointer; transition: background .15s;
}
.export-opt:hover { background: var(--accent); color: #fff; }

.char-count { font-size: 11px; color: var(--text3); }

/* WYSIWYG toolbar */
.format-bar {
  display: flex; gap: 2px; padding: 6px 12px; background: var(--surface);
  border-bottom: 1px solid var(--border); flex-wrap: wrap; align-items: center;
}
.fmt-btn {
  width: 34px; height: 32px; display: flex; align-items: center; justify-content: center;
  background: transparent; border: 1px solid var(--border); border-radius: 6px;
  color: var(--text2); cursor: pointer; font-size: 14px; font-weight: 600; transition: all .15s;
}
.fmt-btn:hover { background: var(--surface2); border-color: #555; color: #fff; }
.fmt-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
.fmt-btn svg { width: 16px; height: 16px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
.fmt-sep { width: 1px; height: 24px; background: var(--border); margin: 0 6px; }
.fmt-select { background: var(--surface2); border: 1px solid var(--border); color: var(--text); border-radius: 6px; padding: 4px 8px; font-size: 12px; cursor: pointer; height: 32px; }
.fmt-select:focus { border-color: var(--accent); outline: none; }

@media (max-width: 768px) {
  .main { grid-template-columns: 1fr; height: auto; }
  .pane { min-height: 50vh; border-right: none; border-bottom: 1px solid var(--border); }
}
</style>
</head>
<body>

<div class="topbar">
  <a href="../index.html" class="back-link">‚Üê Back</a>
  <h1>üìù Rich Text ‚Üî Markdown</h1>
</div>

<div class="toolbar">
  <div class="mode-tabs">
    <div class="mode-tab active" data-mode="rich-to-md">Rich ‚Üí MD</div>
    <div class="mode-tab" data-mode="md-to-rich">MD ‚Üí Rich</div>
  </div>
  <div class="sep"></div>
  <button class="btn btn-sm" id="copy-btn">üìã Copy Output</button>
  <div class="export-wrap">
    <button class="btn btn-sm" id="export-btn">üì• Export ‚ñæ</button>
    <div class="export-menu" id="export-menu">
      <div class="export-opt" data-fmt="md">.md ‚Äî Markdown</div>
      <div class="export-opt" data-fmt="txt">.txt ‚Äî Plain Text</div>
      <div class="export-opt" data-fmt="html">.html ‚Äî HTML</div>
      <div class="export-opt" data-fmt="pdf">.pdf ‚Äî PDF</div>
      <div class="export-opt" data-fmt="docx">.docx ‚Äî Word</div>
    </div>
  </div>
  <button class="btn btn-sm" id="clear-btn">üóë Clear</button>
  <div style="flex:1"></div>
  <span class="char-count" id="char-count">0 chars</span>
</div>

<!-- Rich ‚Üí Markdown mode -->
<div class="main" id="rich-to-md-view">
  <div class="pane">
    <div class="pane-header"><span class="label">Rich Text Input</span><span class="char-count" id="rich-chars">0</span></div>
    <div class="format-bar" id="format-bar">
      <button class="fmt-btn" data-cmd="bold" title="Bold (Ctrl+B)"><b>B</b></button>
      <button class="fmt-btn" data-cmd="italic" title="Italic (Ctrl+I)"><i>I</i></button>
      <button class="fmt-btn" data-cmd="strikeThrough" title="Strikethrough"><s>S</s></button>
      <div class="fmt-sep"></div>
      <button class="fmt-btn" data-block="h1" title="Heading 1" style="font-size:13px;font-weight:800;">H1</button>
      <button class="fmt-btn" data-block="h2" title="Heading 2" style="font-size:13px;font-weight:800;">H2</button>
      <select class="fmt-select" id="fmt-block" title="More headings">
        <option value="">H3‚ÄìH6</option>
        <option value="h3">H3</option>
        <option value="h4">H4</option>
        <option value="h5">H5</option>
        <option value="h6">H6</option>
      </select>
      <button class="fmt-btn" data-block="p" title="Paragraph">¬∂</button>
      <div class="fmt-sep"></div>
      <button class="fmt-btn" data-cmd="insertUnorderedList" title="Bullet List"><svg viewBox="0 0 24 24"><line x1="9" y1="6" x2="20" y2="6"/><line x1="9" y1="12" x2="20" y2="12"/><line x1="9" y1="18" x2="20" y2="18"/><circle cx="5" cy="6" r="1.5" fill="currentColor" stroke="none"/><circle cx="5" cy="12" r="1.5" fill="currentColor" stroke="none"/><circle cx="5" cy="18" r="1.5" fill="currentColor" stroke="none"/></svg></button>
      <button class="fmt-btn" data-cmd="insertOrderedList" title="Numbered List"><svg viewBox="0 0 24 24"><line x1="10" y1="6" x2="20" y2="6"/><line x1="10" y1="12" x2="20" y2="12"/><line x1="10" y1="18" x2="20" y2="18"/><text x="4" y="8" font-size="7" fill="currentColor" stroke="none" font-weight="700">1</text><text x="4" y="14" font-size="7" fill="currentColor" stroke="none" font-weight="700">2</text><text x="4" y="20" font-size="7" fill="currentColor" stroke="none" font-weight="700">3</text></svg></button>
      <button class="fmt-btn" data-block="blockquote" title="Blockquote"><svg viewBox="0 0 24 24"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z" fill="currentColor" stroke="none"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z" fill="currentColor" stroke="none"/></svg></button>
      <button class="fmt-btn" data-cmd="code" title="Code"><svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></button>
      <div class="fmt-sep"></div>
      <button class="fmt-btn" data-cmd="insertImage" title="Insert Image"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></button>
      <button class="fmt-btn" data-cmd="createLink" title="Insert Link"><svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg></button>
      <div class="fmt-sep"></div>
      <button class="fmt-btn" data-cmd="insertHorizontalRule" title="Horizontal Rule"><svg viewBox="0 0 24 24"><line x1="2" y1="12" x2="22" y2="12" stroke-width="3"/></svg></button>
      <button class="fmt-btn" data-cmd="insertTable" title="Insert Table"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg></button>
      <button class="fmt-btn" data-cmd="removeFormat" title="Clear Formatting"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="pane-body">
      <div class="rich-editor" id="rich-input" contenteditable="true"></div>
    </div>
  </div>
  <div class="pane">
    <div class="pane-header"><span class="label">Markdown Output</span><span class="char-count" id="md-out-chars">0</span></div>
    <div class="pane-body">
      <textarea class="md-editor" id="md-output" readonly placeholder="Markdown will appear here‚Ä¶"></textarea>
    </div>
  </div>
</div>

<!-- Markdown ‚Üí Rich mode -->
<div class="main" id="md-to-rich-view" style="display:none">
  <div class="pane">
    <div class="pane-header"><span class="label">Markdown Input</span><span class="char-count" id="md-chars">0</span></div>
    <div class="pane-body">
      <textarea class="md-editor" id="md-input" placeholder="Paste or type markdown here‚Ä¶"></textarea>
    </div>
  </div>
  <div class="pane">
    <div class="pane-header"><span class="label">Rich Text Preview</span></div>
    <div class="pane-body">
      <div class="preview" id="rich-preview"></div>
    </div>
  </div>
</div>

<div class="copy-toast" id="toast">Copied!</div>

<script>
'use strict';

let mode = 'rich-to-md';

// Mode switching
document.querySelectorAll('.mode-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    mode = tab.dataset.mode;
    document.getElementById('rich-to-md-view').style.display = mode === 'rich-to-md' ? '' : 'none';
    document.getElementById('md-to-rich-view').style.display = mode === 'md-to-rich' ? '' : 'none';
  });
});

// ‚îÄ‚îÄ Rich Text ‚Üí Markdown conversion ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function htmlToMarkdown(el) {
  let md = '';
  for (const node of el.childNodes) {
    md += nodeToMd(node);
  }
  // Clean up excessive newlines
  md = md.replace(/\n{3,}/g, '\n\n').trim();
  return md;
}

function nodeToMd(node) {
  if (node.nodeType === Node.TEXT_NODE) {
    return node.textContent;
  }
  if (node.nodeType !== Node.ELEMENT_NODE) return '';

  const tag = node.tagName.toLowerCase();
  const inner = () => {
    let s = '';
    for (const c of node.childNodes) s += nodeToMd(c);
    return s;
  };

  switch (tag) {
    case 'h1': return `# ${inner().trim()}\n\n`;
    case 'h2': return `## ${inner().trim()}\n\n`;
    case 'h3': return `### ${inner().trim()}\n\n`;
    case 'h4': return `#### ${inner().trim()}\n\n`;
    case 'h5': return `##### ${inner().trim()}\n\n`;
    case 'h6': return `###### ${inner().trim()}\n\n`;
    case 'p': return `${inner().trim()}\n\n`;
    case 'br': return '\n';
    case 'hr': return '\n---\n\n';
    case 'strong': case 'b': return `**${inner()}**`;
    case 'em': case 'i': return `*${inner()}*`;
    case 's': case 'del': case 'strike': return `~~${inner()}~~`;
    case 'code':
      if (node.parentElement && node.parentElement.tagName.toLowerCase() === 'pre') return inner();
      return `\`${inner()}\``;
    case 'pre': {
      const code = node.querySelector('code');
      const text = code ? code.textContent : node.textContent;
      const lang = code?.className?.match(/language-(\w+)/)?.[1] || '';
      return `\n\`\`\`${lang}\n${text.trim()}\n\`\`\`\n\n`;
    }
    case 'blockquote': {
      const lines = inner().trim().split('\n');
      return lines.map(l => `> ${l}`).join('\n') + '\n\n';
    }
    case 'a': {
      const href = node.getAttribute('href') || '';
      const text = inner();
      return href ? `[${text}](${href})` : text;
    }
    case 'img': {
      const src = node.getAttribute('src') || '';
      const alt = node.getAttribute('alt') || '';
      return `![${alt}](${src})`;
    }
    case 'ul': return convertList(node, false) + '\n';
    case 'ol': return convertList(node, true) + '\n';
    case 'li': return inner().trim();
    case 'table': return convertTable(node) + '\n';
    case 'div': case 'section': case 'article': case 'main': case 'span': case 'font':
      return inner();
    default: return inner();
  }
}

function convertList(ul, ordered, depth = 0) {
  let md = '';
  const indent = '  '.repeat(depth);
  let idx = 1;
  for (const li of ul.children) {
    if (li.tagName.toLowerCase() !== 'li') continue;
    const bullet = ordered ? `${idx++}.` : '-';
    let text = '';
    let sublist = '';
    for (const c of li.childNodes) {
      const tag = c.tagName?.toLowerCase();
      if (tag === 'ul') sublist += convertList(c, false, depth + 1);
      else if (tag === 'ol') sublist += convertList(c, true, depth + 1);
      else text += nodeToMd(c);
    }
    md += `${indent}${bullet} ${text.trim()}\n`;
    if (sublist) md += sublist;
  }
  return md;
}

function convertTable(table) {
  const rows = [];
  for (const tr of table.querySelectorAll('tr')) {
    const cells = [];
    for (const cell of tr.querySelectorAll('th, td')) {
      cells.push(cell.textContent.trim().replace(/\|/g, '\\|'));
    }
    rows.push(cells);
  }
  if (rows.length === 0) return '';

  let md = '| ' + rows[0].join(' | ') + ' |\n';
  md += '| ' + rows[0].map(() => '---').join(' | ') + ' |\n';
  for (let i = 1; i < rows.length; i++) {
    md += '| ' + rows[i].join(' | ') + ' |\n';
  }
  return md;
}

// ‚îÄ‚îÄ Markdown ‚Üí HTML conversion ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function markdownToHtml(md) {
  let html = md;

  // Code blocks first (protect from other transforms)
  const codeBlocks = [];
  html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
    const idx = codeBlocks.length;
    codeBlocks.push(`<pre><code class="language-${lang}">${esc(code.trim())}</code></pre>`);
    return `%%CODEBLOCK_${idx}%%`;
  });

  // Inline code (protect)
  const inlineCodes = [];
  html = html.replace(/`([^`\n]+)`/g, (_, code) => {
    const idx = inlineCodes.length;
    inlineCodes.push(`<code>${esc(code)}</code>`);
    return `%%INLINE_${idx}%%`;
  });

  // Headers
  html = html.replace(/^######\s+(.+)$/gm, '<h6>$1</h6>');
  html = html.replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>');
  html = html.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
  html = html.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');

  // Horizontal rules
  html = html.replace(/^---+$/gm, '<hr>');

  // Blockquotes
  html = html.replace(/^>\s?(.*)$/gm, '<blockquote>$1</blockquote>');
  html = html.replace(/<\/blockquote>\n<blockquote>/g, '\n');

  // Tables
  html = html.replace(/^(\|.+\|)\n(\|[\s:|-]+\|)\n((?:\|.+\|\n?)+)/gm, (_, header, sep, body) => {
    const ths = header.split('|').filter(c => c.trim()).map(c => `<th>${c.trim()}</th>`).join('');
    const rows = body.trim().split('\n').map(row => {
      const tds = row.split('|').filter(c => c.trim()).map(c => `<td>${c.trim()}</td>`).join('');
      return `<tr>${tds}</tr>`;
    }).join('');
    return `<table><thead><tr>${ths}</tr></thead><tbody>${rows}</tbody></table>`;
  });

  // Lists
  html = convertMdLists(html);

  // Bold & italic
  html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  html = html.replace(/~~(.+?)~~/g, '<del>$1</del>');

  // Links and images
  html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

  // Paragraphs ‚Äî wrap remaining bare text lines
  html = html.split('\n\n').map(block => {
    block = block.trim();
    if (!block) return '';
    if (/^<(h[1-6]|ul|ol|li|table|thead|tbody|tr|th|td|pre|blockquote|hr|div|p)/.test(block)) return block;
    return `<p>${block.replace(/\n/g, '<br>')}</p>`;
  }).join('\n');

  // Restore code blocks
  codeBlocks.forEach((code, i) => { html = html.replace(`%%CODEBLOCK_${i}%%`, code); });
  inlineCodes.forEach((code, i) => { html = html.replace(`%%INLINE_${i}%%`, code); });

  return html;
}

function convertMdLists(text) {
  // Process unordered lists
  text = text.replace(/((?:^[\t ]*[-*+]\s+.+$\n?)+)/gm, (match) => {
    return buildListHtml(match.trim().split('\n'), false);
  });
  // Process ordered lists
  text = text.replace(/((?:^[\t ]*\d+\.\s+.+$\n?)+)/gm, (match) => {
    return buildListHtml(match.trim().split('\n'), true);
  });
  return text;
}

function buildListHtml(lines, ordered) {
  const tag = ordered ? 'ol' : 'ul';
  let html = `<${tag}>`;
  for (const line of lines) {
    const content = line.replace(/^[\t ]*(?:[-*+]|\d+\.)\s+/, '');
    html += `<li>${content}</li>`;
  }
  html += `</${tag}>`;
  return html;
}

function esc(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// ‚îÄ‚îÄ Event handlers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const richInput = document.getElementById('rich-input');
const mdOutput = document.getElementById('md-output');
const mdInput = document.getElementById('md-input');
const richPreview = document.getElementById('rich-preview');
let debounce = null;

// ‚îÄ‚îÄ WYSIWYG toolbar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function execCmd(cmd, value = null) {
  richInput.focus();
  document.execCommand(cmd, false, value);
  triggerConvert();
}

document.querySelectorAll('.fmt-btn[data-cmd]').forEach(btn => {
  btn.addEventListener('mousedown', e => e.preventDefault()); // keep focus in editor
  btn.addEventListener('click', () => {
    const cmd = btn.dataset.cmd;
    if (cmd === 'code') {
      // Wrap selection in <code>
      const sel = window.getSelection();
      if (sel.rangeCount && !sel.isCollapsed) {
        const range = sel.getRangeAt(0);
        const code = document.createElement('code');
        range.surroundContents(code);
        triggerConvert();
      }
    } else if (cmd === 'createLink') {
      const url = prompt('Enter URL:');
      if (url) execCmd('createLink', url);
    } else if (cmd === 'insertImage') {
      const url = prompt('Image URL:');
      if (url) {
        const alt = prompt('Alt text:', '') || '';
        richInput.focus();
        document.execCommand('insertHTML', false, `<img src="${url}" alt="${alt}" style="max-width:100%">`);
        triggerConvert();
      }
    } else if (cmd === 'insertTable') {
      const size = prompt('Table size (rows x cols):', '3x3');
      if (!size) return;
      const [rows, cols] = size.split(/[x√ó,]/).map(n => Math.min(20, Math.max(1, parseInt(n) || 3)));
      let html = '<table><thead><tr>';
      for (let c = 0; c < cols; c++) html += `<th>Header ${c+1}</th>`;
      html += '</tr></thead><tbody>';
      for (let r = 0; r < rows - 1; r++) {
        html += '<tr>';
        for (let c = 0; c < cols; c++) html += '<td>&nbsp;</td>';
        html += '</tr>';
      }
      html += '</tbody></table><p><br></p>';
      richInput.focus();
      document.execCommand('insertHTML', false, html);
      triggerConvert();
    } else {
      execCmd(cmd);
    }
  });
});

document.getElementById('fmt-block').addEventListener('change', e => {
  const val = e.target.value;
  if (!val) return;
  richInput.focus();
  document.execCommand('formatBlock', false, val);
  triggerConvert();
  e.target.value = '';
});

// Block format buttons (H1, H2, ¬∂, blockquote)
document.querySelectorAll('.fmt-btn[data-block]').forEach(btn => {
  btn.addEventListener('mousedown', e => e.preventDefault());
  btn.addEventListener('click', () => {
    const tag = btn.dataset.block;
    richInput.focus();
    document.execCommand('formatBlock', false, tag);
    triggerConvert();
    updateFormatState();
  });
});

// Update active state of format buttons
richInput.addEventListener('keyup', updateFormatState);
richInput.addEventListener('mouseup', updateFormatState);

function updateFormatState() {
  document.querySelectorAll('.fmt-btn[data-cmd]').forEach(btn => {
    const cmd = btn.dataset.cmd;
    if (['bold', 'italic', 'strikeThrough', 'insertUnorderedList', 'insertOrderedList'].includes(cmd)) {
      btn.classList.toggle('active', document.queryCommandState(cmd));
    }
  });
  // Update block buttons active state
  const block = document.queryCommandValue('formatBlock').toLowerCase();
  document.querySelectorAll('.fmt-btn[data-block]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.block === block);
  });
  // Update H3-H6 dropdown
  const sel = document.getElementById('fmt-block');
  const match = [...sel.options].find(o => o.value && o.value.toLowerCase() === block);
  sel.value = match ? match.value : '';
}

function triggerConvert() {
  clearTimeout(debounce);
  debounce = setTimeout(() => {
    mdOutput.value = htmlToMarkdown(richInput);
    updateCounts();
  }, 100);
}

// Rich ‚Üí MD
richInput.addEventListener('input', () => {
  clearTimeout(debounce);
  debounce = setTimeout(() => {
    const md = htmlToMarkdown(richInput);
    mdOutput.value = md;
    updateCounts();
  }, 150);
});

richInput.addEventListener('paste', (e) => {
  // Allow paste to happen naturally, then convert
  setTimeout(() => {
    const md = htmlToMarkdown(richInput);
    mdOutput.value = md;
    updateCounts();
  }, 50);
});

// MD ‚Üí Rich
mdInput.addEventListener('input', () => {
  clearTimeout(debounce);
  debounce = setTimeout(() => {
    richPreview.innerHTML = markdownToHtml(mdInput.value);
    updateCounts();
  }, 150);
});

// Copy
document.getElementById('copy-btn').addEventListener('click', () => {
  let text = '';
  if (mode === 'rich-to-md') {
    text = mdOutput.value;
  } else {
    text = mdInput.value;
  }
  navigator.clipboard.writeText(text).then(() => {
    const toast = document.getElementById('toast');
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 1500);
  });
});

// Clear
document.getElementById('clear-btn').addEventListener('click', () => {
  richInput.innerHTML = '';
  mdOutput.value = '';
  mdInput.value = '';
  richPreview.innerHTML = '';
  updateCounts();
});

function updateCounts() {
  const rc = richInput.textContent.length;
  const mo = mdOutput.value.length;
  const mc = mdInput.value.length;
  document.getElementById('rich-chars').textContent = rc + ' chars';
  document.getElementById('md-out-chars').textContent = mo + ' chars';
  document.getElementById('md-chars').textContent = mc + ' chars';
  document.getElementById('char-count').textContent = (mode === 'rich-to-md' ? mo : mc) + ' chars';
}

/* ‚îÄ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ */
const exportBtn = document.getElementById('export-btn');
const exportMenu = document.getElementById('export-menu');

exportBtn.addEventListener('click', e => {
  e.stopPropagation();
  exportMenu.classList.toggle('open');
});
document.addEventListener('click', () => exportMenu.classList.remove('open'));

function getExportContent() {
  if (mode === 'rich-to-md') {
    return { md: mdOutput.value, html: richInput.innerHTML, text: richInput.textContent };
  } else {
    return { md: mdInput.value, html: richPreview.innerHTML, text: richPreview.textContent };
  }
}

function downloadFile(name, content, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
  toast('Exported ' + name);
}

function exportPdf(htmlContent) {
  const win = window.open('', '_blank');
  win.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Export</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 800px; margin: 40px auto; padding: 0 20px; color: #222; line-height: 1.6; }
h1,h2,h3,h4,h5,h6 { margin: 1em 0 .4em; }
code { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-size: .9em; }
pre { background: #f5f5f5; padding: 12px 16px; border-radius: 8px; overflow-x: auto; }
pre code { background: none; padding: 0; }
blockquote { border-left: 3px solid #7c3aed; padding-left: 12px; color: #555; }
table { border-collapse: collapse; width: 100%; margin: 1em 0; }
th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
th { background: #f5f5f5; }
img { max-width: 100%; }
@media print { body { margin: 0; } }
</style></head><body>${htmlContent}</body></html>`);
  win.document.close();
  setTimeout(() => { win.print(); }, 400);
}

function exportDocx(htmlContent) {
  const docHtml = `<html xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="utf-8"><style>
body { font-family: Calibri, sans-serif; font-size: 11pt; line-height: 1.5; }
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #999; padding: 6px 10px; }
th { background: #f0f0f0; }
code { font-family: Consolas, monospace; background: #f5f5f5; padding: 1px 4px; }
pre { background: #f5f5f5; padding: 10px; font-family: Consolas, monospace; }
blockquote { border-left: 3px solid #7c3aed; padding-left: 10px; color: #555; }
</style></head><body>${htmlContent}</body></html>`;
  const blob = new Blob([docHtml], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'export.docx';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('Exported export.docx');
}

document.querySelectorAll('.export-opt').forEach(opt => {
  opt.addEventListener('click', () => {
    exportMenu.classList.remove('open');
    const fmt = opt.dataset.fmt;
    const c = getExportContent();
    switch (fmt) {
      case 'md':
        downloadFile('export.md', c.md, 'text/markdown');
        break;
      case 'txt':
        downloadFile('export.txt', c.text, 'text/plain');
        break;
      case 'html':
        downloadFile('export.html',
          `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Export</title></head><body>${c.html}</body></html>`,
          'text/html');
        break;
      case 'pdf':
        exportPdf(c.html);
        break;
      case 'docx':
        exportDocx(c.html);
        break;
    }
  });
});
</script>
</body>
</html>
